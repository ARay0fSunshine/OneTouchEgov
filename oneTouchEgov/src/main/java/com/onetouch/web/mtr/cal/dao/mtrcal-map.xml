<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onetouch.web.mtr.cal.dao.MtrCalMapper">
	<!-- 재고조정내역 조건 조회 -->
	<select id="selectCal" resultType="com.onetouch.web.mtr.cal.dao.MtrCalVO">
		SELECT 
			A.CAL_NO,
			A.MTR_LOT,
			TO_CHAR(A.CAL_DATE, 'yyyy-MM-dd') AS CAL_DATE,
            A.CAL_SECT,
			FN_GET_BAS_DTL_CD_TO_NM(A.CAL_SECT) AS CAL_SECT_NM,
			C.UNIT,
			FN_GET_BAS_DTL_CD_TO_NM(C.UNIT) AS UNIT_NM,
			A.CAL_AMT,
			A.CMT,
			B.MTR_CD,
			FN_GET_MTR_CD_TO_NM(B.MTR_CD) AS MTR_NM
		FROM
			MTR_STCK_CAL A, MTR_LOT_STCK B, ADM_MTR C
		WHERE
			A.MTR_LOT = B.MTR_LOT
		AND
			B.MTR_CD = C.MTR_CD
		<if test="startDate != null and startDate != ''"> 
			<![CDATA[AND TO_CHAR(A.CAL_DATE, 'yyyy-MM-dd') >= #{startDate}]]>
		</if>
		<if test="endDate != null and endDate != ''"> 
			<![CDATA[AND TO_CHAR(A.CAL_DATE, 'yyyy-MM-dd') <= #{endDate}]]>
		</if>
		<if test="calSect != null and calSect != ''">
			AND A.CAL_SECT = #{calSect}
		</if>
		<if test="ditemCode != null and ditemCode != ''">
			AND B.MTR_CD = #{ditemCode}
		</if>
	</select>
	
	<select id="selectInNo" resultType="int">
		SELECT 
			PKG_MAKE_CODE_SEQ.CODE('MTR_IN', 'IN_NO', 'IN_DATE')
		FROM
			DUAL
	</select>
	<!-- 입고 테이블에 등록 -->
	<insert id="insertIn">
		INSERT INTO MTR_IN (
			IN_NO,
			MTR_CD,
			IN_DATE,
			ORD_NO,
			UNIT,
			IN_AMT,
			FLT_AMT,
			UNIT_COST,
			TOT_COST
			)
		VALUES(
			#{inNo},
			#{mtrCd},
			SYSDATE,
			#{ordNo},
			#{unit},
			#{inAmt},
			#{fltAmt},
			#{unitCost},
			(#{unitCost}*#{inAmt})
			)
	</insert>
	<!-- 입고등록후 발주디테일에 수량업데이트 -->
	<update id="updateOrd">
		UPDATE MTR_ORD_DTL
		SET
			IN_AMT = (NVL(IN_AMT,0)+#{inAmt}),
			FLT_AMT = (NVL(FLT_AMT,0)+#{fltAmt}),
			NOTIN_AMT = ((SELECT 
								ORD_AMT FROM MTR_ORD_DTL 
							WHERE 
								ORD_NO = #{ordNo}
							AND
								MTR_CD = #{mtrCd})
						-(NVL(IN_AMT,0)+#{inAmt})
						-(NVL(FLT_AMT,0)+#{fltAmt}))
		WHERE
			ORD_NO = #{ordNo} 
		AND
			MTR_CD = #{mtrCd}
	</update>
	<update id="updateIn">
		UPDATE MTR_IN
		SET
			MTR_CD = #{mtrCd},
			UNIT = #{unit},
			IN_AMT = #{inAmt},
			FLT_AMT = #{fltAmt},
			UNIT_COST = #{unitCost},
			TOT_COST = (#{unitCost}*#{inAmt})
		WHERE
			IN_NO = #{inNo}
	</update>
	<!-- 하나씩 삭제 -->
	<delete id="deleteIn">
		DELETE 
		FROM MTR_IN
		WHERE IN_NO = #{inNo}
	</delete>
	<update id="prdNeed">
		update MTR_LOT_STCK
		set 
		HLD_CNT = #{hldCnt},
		STCK_CNT = STCK_CNT-#{hldCnt}
		WHERE 
		MTR_LOT = #{mtrLot}
	</update>
	<!-- 자재출고테이블 지시때 출고처리해야댐 -->
	<!-- 지시때 lot재고에도 반영해야댐 -->
	<insert id="prdOut">
		<!-- hldCnt: "3"
instrCnt: "3"
mtrCd: "MF001"
mtrLot: "MLT2022010061"
needCnt: "100"
planNo: "PPL202201110001"
prdCd: "prd_001"
stckCnt: "1" -->
	</insert>

	<!-- 리스트로받아서 for문으로 다 삭제하는쿼리 -->
	<!-- <delete id="delete">
		DELETE 
		FROM MTR_IN
		WHERE IN_NO IN
		<foreach collection="list" item="vo" open="(" close=")" separator=",">
		#{vo.inNo}
	</foreach>
	</delete> -->
</mapper>